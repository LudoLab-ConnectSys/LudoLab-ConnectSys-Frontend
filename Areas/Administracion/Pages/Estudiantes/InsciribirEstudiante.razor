@page "/matricular-estudiante"
@inject NavigationManager NavigationManager
@inject HttpClient Http

<h3 class="text-center my-4">Registrar y Matricular Estudiante</h3>

<EditForm Model="@nuevoUsuario" OnValidSubmit="HandleValidSubmit" class="container">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Datos del Usuario -->
                    <div class="form-group mb-3">
                        <label for="cedula">Cédula:</label>
                        <InputText id="cedula" class="form-control" @bind-Value="nuevoUsuario.cedula_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="nombre">Nombre:</label>
                        <InputText id="nombre" class="form-control" @bind-Value="nuevoUsuario.nombre_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="apellidos">Apellidos:</label>
                        <InputText id="apellidos" class="form-control" @bind-Value="nuevoUsuario.apellidos_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="edad">Edad:</label>
                        <InputNumber id="edad" class="form-control" @bind-Value="nuevoUsuario.edad_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="correo">Correo Electrónico:</label>
                        <InputText id="correo" class="form-control" @bind-Value="nuevoUsuario.correo_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="celular">Número de Celular:</label>
                        <InputText id="celular" class="form-control" @bind-Value="nuevoUsuario.celular_usuario" />
                    </div>
                    <div class="form-group mb-3">
                        <label for="telefono">Número de Teléfono:</label>
                        <InputText id="telefono" class="form-control" @bind-Value="nuevoUsuario.telefono_usuario" />
                    </div>

                    <!-- Datos del Estudiante -->
                    <div class="form-group mb-3">
                        <label for="tipoEstudiante">Tipo de Estudiante:</label>
                        <InputSelect id="tipoEstudiante" class="form-control" @bind-Value="nuevoEstudiante.tipo_estudiante">
                            <option value="">Seleccione un tipo</option>
                            <option value="Docente">Docente</option>
                            <option value="Grupo de atención prioritaria">Grupo de atención prioritaria</option>
                        </InputSelect>
                    </div>

                    <!-- Selección de Curso -->
                    <div class="form-group mb-3">
                        <label for="curso">Curso:</label>
                        <select id="curso" class="form-control" @onchange="OnCursoSeleccionadoChange">
                            <option value="">Seleccione un curso</option>
                            @foreach (var curso in cursos)
                            {
                                <option value="@curso.id_curso">@curso.nombre_curso</option>
                            }
                        </select>
                    </div>

                    <!-- Selección de Periodo -->
                    <div class="form-group mb-3">
                        <label for="periodo">Periodo:</label>
                        <InputSelect id="periodo" class="form-control" @bind-Value="idPeriodoSeleccionado">
                            <option value="">Seleccione un periodo</option>
                            @foreach (var periodo in periodosUnicos)
                            {
                                <option value="@periodo.id_periodo">@periodo.nombre_periodo</option>
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button type="submit" class="btn btn-success me-2">Guardar y Matricular</button>
                    <button type="button" class="btn btn-secondary" @onclick="Regresar">Cancelar</button>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-2">@errorMessage</div>
                    }
                </div>
            </div>
        </div>
    </div>
</EditForm>

@code {
    private DirectorioDeArchivos.Shared.Usuario nuevoUsuario = new DirectorioDeArchivos.Shared.Usuario();
    private DirectorioDeArchivos.Shared.Estudiante nuevoEstudiante = new DirectorioDeArchivos.Shared.Estudiante();
    private List<Curso> cursos = new List<Curso>();
    private List<PeriodoConNombre> periodosUnicos = new List<PeriodoConNombre>();
    private int idCursoSeleccionado;
    private int idPeriodoSeleccionado;
    private string errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await CargarCursos();
    }

    private async Task CargarCursos()
    {
        try
        {
            cursos = await Http.GetFromJsonAsync<List<Curso>>("http://localhost:5117/api/Curso");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar los cursos: {ex.Message}";
        }
    }

    private async Task CargarPeriodos(int idCurso)
    {
        try
        {
            Console.WriteLine($"Cargando periodos para el curso con ID: {idCurso}");
            periodosUnicos = await Http.GetFromJsonAsync<List<PeriodoConNombre>>($"http://localhost:5117/api/Periodo/por-curso/{idCurso}");
            Console.WriteLine($"Periodos cargados: {periodosUnicos.Count}");
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Error al cargar los periodos: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inesperado al cargar los periodos: {ex.Message}";
        }
    }

    private async Task OnCursoSeleccionadoChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value.ToString(), out int idCurso))
        {
            idCursoSeleccionado = idCurso;
            Console.WriteLine($"Curso seleccionado: {idCursoSeleccionado}");
            await CargarPeriodos(idCursoSeleccionado);
        }
        else
        {
            errorMessage = "El ID del curso seleccionado no es válido.";
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var usuarioId = await GuardarUsuario();

            nuevoEstudiante.id_usuario = usuarioId;
            var estudianteId = await GuardarEstudiante(nuevoEstudiante);
            await RegistrarMatricula(estudianteId, idCursoSeleccionado, idPeriodoSeleccionado);

            NavigationManager.NavigateTo("/");
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task<int> GuardarUsuario()
    {
        var response = await Http.PostAsJsonAsync("http://localhost:5117/api/Usuario", nuevoUsuario);
        response.EnsureSuccessStatusCode();
        var usuarioCreado = await response.Content.ReadFromJsonAsync<DirectorioDeArchivos.Shared.Usuario>();
        return usuarioCreado.id_usuario;
    }

    private async Task<int> GuardarEstudiante(DirectorioDeArchivos.Shared.Estudiante estudiante)
    {
        var response = await Http.PostAsJsonAsync("http://localhost:5117/api/Estudiante", estudiante);
        response.EnsureSuccessStatusCode();
        var estudianteCreado = await response.Content.ReadFromJsonAsync<DirectorioDeArchivos.Shared.Estudiante>();
        return estudianteCreado.id_estudiante;
    }

    private async Task RegistrarMatricula(int id_estudiante, int id_curso, int id_periodo)
    {
        var nuevaMatricula = new Matricula
            {
                id_estudiante = id_estudiante,
                id_curso = id_curso,
                id_periodo = id_periodo,
                fecha_inscripcion = DateTime.Now
            };

        var response = await Http.PostAsJsonAsync("http://localhost:5117/api/Matricula", nuevaMatricula);
        response.EnsureSuccessStatusCode();
    }

    private void Regresar()
    {
        NavigationManager.NavigateTo("/estudiantes");
    }
}
